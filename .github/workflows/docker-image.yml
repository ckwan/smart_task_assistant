name: Docker Test & Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # Set up Docker Buildx (for building images)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Log in to Docker (optional if using private registries)
      #- name: Log in to Docker Hub
      #  uses: docker/login-action@v2
      #  with:
      #    username: ${{ secrets.DOCKER_USERNAME }}
      #    password: ${{ secrets.DOCKER_PASSWORD }}

      # Build backend Docker image
      - name: Build backend image
        run: docker build -t smart-task-backend .

      # Start services with Docker Compose
      - name: Start services
        uses: docker/compose-action@v4
        with:
          compose-file: docker-compose.yml
          project-name: smarttaskci
          run: up -d

      # Wait for Postgres to be healthy
      - name: Wait for DB
        run: |
          echo "Waiting for Postgres to be ready..."
          until docker exec smarttaskci_postgres_1 pg_isready -U ${{ secrets.POSTGRES_USER }}; do
            sleep 2
          done

      # Set DATABASE_URL environment variable
      - name: Set DATABASE_URL
        run: |
          echo "DATABASE_URL=postgresql+psycopg2://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/${{ secrets.POSTGRES_DB }}" >> $GITHUB_ENV

      # 8️⃣ Run pytest inside the backend container
      - name: Run tests with coverage
        run: |
          docker exec smarttaskci_backend_1 pytest --cov=app --cov-report=term-missing --cov-fail-under=70

